<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>【CompletableFuture详解】换一种理解角度 - 被忽略的函数式接口</title>
      <link href="/2024/02/05/1-CompletableFuture/"/>
      <url>/2024/02/05/1-CompletableFuture/</url>
      
        <content type="html"><![CDATA[<h1 id="CompletableFuture"><a href="#CompletableFuture" class="headerlink" title="CompletableFuture"></a>CompletableFuture</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>很多文章在介绍CompletableFuture时都是照功能将方法划分为不同类型，直接解释具体方法的使用规则。可如果你本就英语不好，看到几个差不多的单词排列组合成几十种方法是不是头皮发麻了？又或者你经常搞混或忘记相似方法，实战根本不知道怎么用。进一步讲，当嵌套了多组括号和回调，且由于不同方法的入参和返回值不同，经常代码检查报错摸不着头脑。</p><p>如果你有这些感觉，那么看完本文对你一定会有收获。本文不会直接告诉你那么多API具体如何使用，而是教会你如何高效区分和掌握不同API的用法。</p><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>JDK8中新增了CompletableFuture类作为异步任务编排的解决方案，它可以被认为是Future的扩展，采用了函数式编程思想简化了任务编排和回调地狱，本文的CompletableFuture会以JDK8为准。</p><h2 id="理解函数式接口"><a href="#理解函数式接口" class="headerlink" title="理解函数式接口"></a>理解函数式接口</h2><p>如何做到快速掌握用法？其实很简单，就是被忽略的函数式接口。很多文章认为直接把方法翻译为具体功能更简单易懂，其实不然，其听我慢慢道来。</p><p>我们先来看看<code>thenCombine</code>方法的声明：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;U,V&gt; CompletableFuture&lt;V&gt; <span class="title function_">thenCombine</span></span><br><span class="line">        <span class="params">(CompletionStage&lt;? extends U&gt; other,</span></span><br><span class="line"><span class="params">         BiFunction&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> U,? extends V&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doThenCombine(other.toCompletableFuture(), fn, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这？这一坨都是啥？不急，你不需要理解任何东西，混个眼熟就行，根据功能的不同，CompletableFuture中API的函数式接口入参只有以下六种：</p><table><thead><tr><th>函数式接口</th><th>入参</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>Runnable</td><td>-</td><td>-</td><td>可运行函数：无入参，无结果</td></tr><tr><td>Supplier<T></td><td>-</td><td>T</td><td>提供者函数：仅返回结果</td></tr><tr><td>Consumer<T></td><td>T</td><td>-</td><td>消费者函数：仅消费参数</td></tr><tr><td>Function&lt;T, R&gt;</td><td>T</td><td>R</td><td>一元函数：输入参数，产生结果</td></tr><tr><td>BiFunction&lt;T, U, R&gt;</td><td>T, U</td><td>R</td><td>二元函数：输入两个参数，产生结果</td></tr><tr><td>BiConsumer&lt;T, U&gt;</td><td>T, U</td><td>-</td><td>二元消费者：输入两个参数，无结果</td></tr></tbody></table><p>函数式接口是JDK8新增的一个有且仅有一个抽象方法的接口，用于规定函数式方法，可适用于lambda表达式的书写。当然在本文你可以简单理解为用于规定任务的函数特点（参数和返回值）。</p><p>那么请猜一下下面这个函数式接口的含义是什么？</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Function&lt;? <span class="built_in">super</span> T, ? <span class="keyword">extends</span> <span class="title class_">CompletionStage</span>&lt;U&gt;&gt;</span><br></pre></td></tr></table></figure><p>根据上表，它表示一个一元函数，入参为T以及其子类，返回值为<code>CompletionStage&lt;U&gt;</code>类型及其子类。</p><p><strong><code>CompletionStage&lt;U&gt;</code>是何方神圣？它即是CompletableFuture除了Future以外实现的另一个接口，它被描述为异步任务的阶段，定义的任务的阶段操作都会返回一个<code>CompletionStage</code>类型，可链式调用编排任务。</strong></p><p>那么回到刚刚的<code>thenCombine</code>方法，看看它的入参和返回值：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thenCombine入参</span></span><br><span class="line">(CompletionStage&lt;? <span class="keyword">extends</span> <span class="title class_">U</span>&gt; other, BiFunction&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> U,? <span class="keyword">extends</span> <span class="title class_">V</span>&gt; fn)</span><br><span class="line"><span class="comment">// thenCombine返回值</span></span><br><span class="line">CompletableFuture&lt;V&gt;</span><br></pre></td></tr></table></figure><p>接受一个<code>CompletionStage</code>和一个<code>BiFunction</code>（二元函数），返回一个<code>CompletionStage</code></p><p>注意以下几部分：</p><ul><li>返回值的泛型<code>&lt;V&gt;</code>，它是参数二BiFunction&lt;? super T,? super U,<code>? extends V</code>&gt;二元函数定义的返回值泛型。</li><li>参数一的泛型<code>&lt;U&gt;</code>，它是参数二BiFunction&lt;? super T,<code>? super U</code>,? extends V&gt;二元函数定义的第二个入参泛型。</li><li>那么二元函数剩下的那个<code>&lt;T&gt;</code>代表什么呢？没错！（突然激动）正是调用者CompletableFuture本身的泛型！</li></ul><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_10-47-14.png" alt="PixPin_2024-02-06_10-47-14"></p><p>最后再看看这个函数的名称thenCombine：”然后结合“，那么这个API的功能就显而易见了：调用者本身作为一个任务产生一个结果<code>T</code>，方法参数传入另一个任务产生结果<code>U</code>，通过二元函数<code>BiFunction</code>结合两个结果产生最终的返回值<code>V</code>。</p><p>让我们看看这个方法实际的用法，其中两个任务是同时进行的，后面会讲到：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// supplyAsync异步执行第一个任务</span></span><br><span class="line">CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;厨师做饭&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;蛋炒饭&quot;</span>, <span class="number">40</span>);</span><br><span class="line">    <span class="comment">// thenCombine结合另一个supplyAsync异步任务</span></span><br><span class="line">&#125;).thenCombine(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;厨师煲汤&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;鱼汤&quot;</span>, <span class="number">20</span>);</span><br><span class="line">    <span class="comment">// 二元函数接收两个任务结果，处理并返回最终结果（使用Lambda表达式简化匿名内部类的书写）</span></span><br><span class="line">&#125;), (rice, soup) -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;顾客吃饭：&quot;</span> + rice.getName() + <span class="string">&quot; 顾客喝汤：&quot;</span> + soup.getName());</span><br><span class="line">    <span class="keyword">return</span> rice.getPrice() + soup.getPrice();</span><br><span class="line">&#125;);</span><br><span class="line">print(<span class="string">&quot;餐厅收款：&quot;</span> + future2.join() + <span class="string">&quot;元&quot;</span>);</span><br></pre></td></tr></table></figure><p>如果你还是有点晕，让我们再看下面两个方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thenCompose</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenCompose</span><span class="params">(Function&lt;? <span class="built_in">super</span> T, ? extends CompletionStage&lt;U&gt;&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doThenCompose(fn, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// thenApply</span></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletableFuture&lt;U&gt; <span class="title function_">thenApply</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doThenApply(fn, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这两个方法的功能都是作为任务的回调函数，通过一元函数<code>Function</code>处理任务结果，产生最终结果，他们有什么区别呢？</p><p>注意看一元函数<code>Function</code>：</p><ul><li><code>thenCompose</code>方法一元函数返回值的泛型为<code>&lt;? extends CompletionStage&lt;U&gt;&gt; </code></li><li><code>thenApply</code>方法一元函数返回值的泛型为<code>&lt;? extends U&gt;</code></li></ul><p>也就是说，thenCompose必须返回另一个CompletionStage任务结果，而thenApply可以返回任意形式的结果。这和它们的名称也是一致的，Compose为组合（任务），Apply为接受。</p><p>还有一个类似功能的回调方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletableFuture&lt;Void&gt; <span class="title function_">thenAccept</span><span class="params">(Consumer&lt;? <span class="built_in">super</span> T&gt; action)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> doThenAccept(action, <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>那么它与前两者的区别也很明显了，thenAccept的入参是<code>Consumer</code>接口，不产生返回值。</p><p>什么是恍然大明白！看到这里你已经完全掌握CompletableFuture了（开个玩笑）</p><p>接下来会带你全方面认识CompletableFuture，如果你能理解上文说所的，那么继续往下看你就可以很轻松地理解区分CompletableFuture的其他方法。</p><h1 id="方法详解"><a href="#方法详解" class="headerlink" title="方法详解"></a>方法详解</h1><p><strong>CompletableFuture的API可以粗略分为：创建任务、获取结果、任务编排、特殊处理，其中任务编排包括任务连接和任务组合两种。</strong></p><h2 id="创建任务"><a href="#创建任务" class="headerlink" title="创建任务"></a>创建任务</h2><table><thead><tr><th>API</th><th>入参</th><th>返回值</th><th>解释</th></tr></thead><tbody><tr><td>supplyAsync</td><td>Supplier<U></td><td>CompletableFuture<U></td><td>异步任务，有返回值</td></tr><tr><td>runAsync</td><td>Runnable</td><td>CompletableFuture<Void></td><td>异步任务，无返回值</td></tr><tr><td>completedFuture</td><td>U</td><td>CompletableFuture<U></td><td>直接获取一个任务结果</td></tr></tbody></table><ul><li><code>supplyAsync</code>方法和<code>runAsync</code>方法通过实现不同的函数式接口获得一个异步任务，还记得函数式接口那张表吗，<code>Supplier</code>提供一个返回值，而<code>Runnable</code>不提供。</li><li><code>completedFuture</code>方法可以直接传递一个处理完的结果，不需要实现一个函数式接，可以用于将结果封装为任务。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 异步创建一个有返回值的任务</span></span><br><span class="line">CompletableFuture&lt;Food&gt; future1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;厨师做饭&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;蛋炒饭&quot;</span>, <span class="number">40</span>);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 异步创建一个没有返回值的任务</span></span><br><span class="line">CompletableFuture&lt;Void&gt; future2 = CompletableFuture.runAsync(() -&gt; System.out.println(<span class="string">&quot;厨师做饭&quot;</span>));                                               </span><br><span class="line"><span class="comment">// 直接创建一个任务</span></span><br><span class="line">CompletableFuture&lt;Object&gt; future3 = CompletableFuture.completedFuture(<span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;蛋炒饭&quot;</span>, <span class="number">40</span>));</span><br></pre></td></tr></table></figure><h2 id="获取结果"><a href="#获取结果" class="headerlink" title="获取结果"></a>获取结果</h2><p>CompletableFuture实现了Future接口获取返回值的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">V <span class="title function_">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException;</span><br><span class="line"></span><br><span class="line">V <span class="title function_">get</span><span class="params">(<span class="type">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</span><br></pre></td></tr></table></figure><p>除此之外，你还可以使用join方法，区别是join帮你捕获了异常：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 等待任务完成获取返回值，需要手动捕获或抛出异常</span></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> future1.get();</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException | ExecutionException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 等待任务完成获取返回值，不需要手动处理异常</span></span><br><span class="line"><span class="type">Food</span> <span class="variable">food</span> <span class="operator">=</span> future1.join();</span><br></pre></td></tr></table></figure><h2 id="任务编排"><a href="#任务编排" class="headerlink" title="任务编排"></a>任务编排</h2><p>任务编排的API都有三种形式，分别为：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xxx(args...);</span><br><span class="line">xxxAsync(args...);</span><br><span class="line">xxxAsync(args..., Executor executor);</span><br></pre></td></tr></table></figure><ul><li>其中不带<code>Async</code>的为原始方法，默认使用CompletableFuture自带的线程池<code>ForkJoinPool</code>。</li><li>带有<code>Async</code>的被看作是另一个任务阶段，带有<code>Executor</code>的方法可以传入自定义的线程池用于执行任务，带有<code>Executor</code>的方法使用<code>ForkJoinPool</code>。</li></ul><p>这些方法返回值都是CompletionStage类型，具体泛型根据参数中的函数式接口返回值判断，若是Runnable则为<code>&lt;Void&gt;</code>，否则为函数式接口返回值泛型，例如<code>&lt;U&gt;</code>或<code>&lt;V&gt;</code>。</p><p>以刚刚的thenApply为例：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xxx(args...);</span></span><br><span class="line">CompletionStage&lt;U&gt; <span class="title function_">thenApply</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span>;</span><br><span class="line"><span class="comment">// xxxAsync(args...);</span></span><br><span class="line">CompletionStage&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn)</span>;</span><br><span class="line"><span class="comment">// xxxAsync(args..., Executor executor);</span></span><br><span class="line">CompletionStage&lt;U&gt; <span class="title function_">thenApplyAsync</span><span class="params">(Function&lt;? <span class="built_in">super</span> T,? extends U&gt; fn, Executor executor)</span>;</span><br></pre></td></tr></table></figure><p><strong>之前创建任务的两个方法supplyAsync和runAsync都有对应的Executor重载方法，但没有非Async方法。后面的方法都以不带Async的为例。</strong></p><h3 id="任务连接"><a href="#任务连接" class="headerlink" title="任务连接"></a>任务连接</h3><table><thead><tr><th>API</th><th>入参</th></tr></thead><tbody><tr><td>thenCompose</td><td><code>Function</code>&lt;? super T, ? extends CompletionStage<U>&gt;</td></tr><tr><td>thenAccept</td><td><code>Consumer</code>&lt;? super T&gt;</td></tr><tr><td>thenApply</td><td><code>Function</code>&lt;? super T,? extends U&gt;</td></tr><tr><td>thenRun</td><td><code>Runnable</code></td></tr></tbody></table><p>以上4种方法都是等待任务结束后执行的回调方法，它们的用法区别为：任务之间的交互性质不同（参数和返回值），选用不同的函数式接口实现。</p><p>例如下面的代码，顾客需要接收前面厨师返回的蛋炒饭，吃完返回金钱，因此选用<code>thenCompose</code>这一使用<code>Function</code>函数式接口的方法。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// thenCompose连接两个任务</span></span><br><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;厨师做饭&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;蛋炒饭&quot;</span>, <span class="number">40</span>);</span><br><span class="line">&#125;).thenCompose(food -&gt; CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        print(<span class="string">&quot;顾客吃饭：&quot;</span> + food.getName());</span><br><span class="line">    <span class="comment">// TODO 扣减金钱操作</span></span><br><span class="line">        <span class="keyword">return</span> food.getPrice();</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure><p>你也许会好奇，<code>thenApply</code>方法不也是<code>Function</code>吗，该怎么选，偷偷告诉你在前面理解函数式接口一节中已经讲述了这几个方法之间的区别了，如果你已经忘了，那……建议反复阅读第二节。<br>其实使用<code>thenApply</code>也是可以的，只不过<code>thenCompose</code>需要明确返回另一个CompletionStage任务对象。</p><h3 id="任务组合"><a href="#任务组合" class="headerlink" title="任务组合"></a>任务组合</h3><table><thead><tr><th align="left">API</th><th>入参1</th><th>入参2</th><th>解释</th></tr></thead><tbody><tr><td align="left">runAfterBoth</td><td>CompletionStage&lt;?&gt;</td><td><code>Runnable</code></td><td>两个任务都完成后执行可运行函数</td></tr><tr><td align="left">thenCombine</td><td>CompletionStage&lt;? extends U&gt;</td><td><code>BiFunction</code>&lt;? super T,? super U,? extends V&gt;</td><td>两个任务都完成后返回值传递给二元函数</td></tr><tr><td align="left">applyToEither</td><td>CompletionStage&lt;? extends T&gt;</td><td><code>Function</code>&lt;? super T, U&gt;</td><td>任意任务完成后返回值传递给一元函数</td></tr><tr><td align="left">acceptEither</td><td>CompletionStage&lt;? extends T&gt;</td><td><code>Consumer</code>&lt;? super T&gt;</td><td>任意任务完成后返回值传递给消费者</td></tr></tbody></table><p>注意几点：</p><ul><li>这四种方法都是用来组合两个CompletionStage任务的，第一个任务即调用者，第二个任务作为参数传入。</li><li>前两种方法需要实现不关心参数的<code>Runnable</code>，一个是需要实现带有两个参数的<code>BiFunction</code>，对应功能为等待两个任务都完成。</li><li>后两种方法传入的任务泛型为<code>&lt;T&gt;</code>，即CompletableFuture调用者本身泛型，也就是说两个任务的返回类型要保持一致，这与其功能是一致的，即任意任务结束后返回值传递给后面定义的函数处理。</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用applyToEither组合两个任务。</span></span><br><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;一号公交车正在赶来&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;).applyToEither(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;二号公交车正在赶来&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 开启了第三个任务用于实现一元函数</span></span><br><span class="line">&#125;), number -&gt; CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;上了&quot;</span> + number + <span class="string">&quot;号公交&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> number;</span><br><span class="line">&#125;).join());</span><br></pre></td></tr></table></figure><p>如果一元函数使用代码块，不开启第三个任务，则上公交车的任务与先赶来的公交车的任务处于同一阶段，不会开启新线程。如果此时改用<code>applyToEitherAsync</code>则会直接开启第三任务线程。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;一号公交车正在赶来&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;).applyToEither(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;二号公交车正在赶来&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// 上了哪辆车，就属于哪个任务</span></span><br><span class="line">&#125;), number -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;上了&quot;</span> + number + <span class="string">&quot;号公交&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> number;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>任务组合还有两个常用的方法：</p><table><thead><tr><th>API</th><th>入参</th><th>解释</th></tr></thead><tbody><tr><td>allOf</td><td>CompletableFuture&lt;?&gt;… cfs</td><td>所有任务完成后产生结果</td></tr><tr><td>anyOf</td><td>CompletableFuture&lt;?&gt;… cfs</td><td>任意任务结束后产生结果</td></tr></tbody></table><p>这两个方法可以解决多个任务相互组合的情景，以上面公交车为例，有三个公交车的情况可以这样写：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; bus1 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;一号公交车正在赶来&quot;</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;, executor);</span><br><span class="line">CompletableFuture&lt;Integer&gt; bus2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;二号公交车正在赶来&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;, executor);</span><br><span class="line">CompletableFuture&lt;Integer&gt; bus3 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;三号公交车正在赶来&quot;</span>);</span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">&#125;, executor);</span><br><span class="line">CompletableFuture.anyOf(bus1, bus2, bus3).thenApply(number -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;上了&quot;</span> + number + <span class="string">&quot;号公交&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> number;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>或者简写成：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture.anyOf(</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        print(<span class="string">&quot;一号公交车正在赶来&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;, executor),</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        print(<span class="string">&quot;二号公交车正在赶来&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">    &#125;, executor),</span><br><span class="line">    CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        print(<span class="string">&quot;三号公交车正在赶来&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    &#125;, executor)</span><br><span class="line">).thenApply(number -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;上了&quot;</span> + number + <span class="string">&quot;号公交&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> number;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>上面介绍的10种任务编排方法，每种方法有3种形式，一共会产生30种方法，根据函数式接口和函数名能够迅速区分开它们的用法。</p><h2 id="特殊处理"><a href="#特殊处理" class="headerlink" title="特殊处理"></a>特殊处理</h2><p>如果任务里出现了异常该如何通知其他任务，如何进行处理呢？CompletableFuture提供了集中特殊处理的方法：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> CompletionStage&lt;T&gt; <span class="title function_">whenComplete</span><span class="params">(BiConsumer&lt;? <span class="built_in">super</span> T, ? <span class="built_in">super</span> Throwable&gt; action)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;U&gt; CompletionStage&lt;U&gt; <span class="title function_">handle</span><span class="params">(BiFunction&lt;? <span class="built_in">super</span> T, Throwable, ? extends U&gt; fn)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> CompletionStage&lt;T&gt; <span class="title function_">exceptionally</span><span class="params">(Function&lt;Throwable, ? extends T&gt; fn)</span>;</span><br></pre></td></tr></table></figure><p>这几个方法可以实现回调函数处理异常，其中<code>whenComplete</code>和<code>handle</code>同样有对应的xxxAsync形式。前面任务若抛出异常则交给Throwable参数，若无异常则为null。</p><p>相信你已经可以通过函数式接口很轻松的区分它们的用法了。</p><p>除此之外，CompletableFuture还提供了其他一些操作例如取消和超时操作等，不再演示。</p><h1 id="原理详解"><a href="#原理详解" class="headerlink" title="原理详解"></a>原理详解</h1><h2 id="ForkJoinPool"><a href="#ForkJoinPool" class="headerlink" title="ForkJoinPool"></a>ForkJoinPool</h2><p>CompletableFuture默认提供的线程池为ForkJoinPool，他的核心线程数为处理器数量减一，例如8核16线程的电脑对应的最大线程数为15。</p><p>为了达到业务线程隔离的目的，通常推荐使用自定义Executor的异步方法，也就是xxxAsync带有Executor参数的方法，且子任务和父任务应该使用不同的线程池，防止线程池循环引用导致死锁。</p><h2 id="Async方法理解"><a href="#Async方法理解" class="headerlink" title="Async方法理解"></a>Async方法理解</h2><p>刚刚等待两辆公交车的例子中使用了applyToEither，哪辆公交车先到达，乘客的函数任务线程就会沿用公交车对应的线程，这很好理解，但如果是厨师的例子呢，顾客函数等待做饭和煲汤两个任务：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CompletableFuture&lt;Integer&gt; future2 = CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;厨师做饭&quot;</span>);</span><br><span class="line">    sleep(<span class="number">200</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;蛋炒饭&quot;</span>, <span class="number">40</span>);</span><br><span class="line">&#125;, EXECUTOR).thenCombine(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;厨师煲汤&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1000</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Food</span>(<span class="string">&quot;鱼汤&quot;</span>, <span class="number">20</span>);</span><br><span class="line">&#125;, EXECUTOR), (rice, soup) -&gt; &#123;</span><br><span class="line">    print(<span class="string">&quot;顾客吃饭：&quot;</span> + rice.getName() + <span class="string">&quot; 顾客喝汤：&quot;</span> + soup.getName());</span><br><span class="line">    <span class="keyword">return</span> rice.getPrice() + soup.getPrice();</span><br><span class="line">&#125;);</span><br><span class="line">print(<span class="string">&quot;餐厅收款：&quot;</span> + future2.join() + <span class="string">&quot;元&quot;</span>);</span><br></pre></td></tr></table></figure><p>这里我让做饭随眠200毫秒，煲汤随眠1000毫秒，打印出结果（睡眠和打印都是自定义的方法）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1 -&gt; 厨师做饭</span><br><span class="line">pool-1-thread-2 -&gt; 厨师煲汤</span><br><span class="line">pool-1-thread-2 -&gt; 顾客吃饭：蛋炒饭 顾客喝汤：鱼汤</span><br><span class="line">main -&gt; 餐厅收款：60元</span><br></pre></td></tr></table></figure><p>结果顾客线程与睡眠时间较长的任务使用了同一个线程吗，我们把睡眠时间交换一下同样成立：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1 -&gt; 厨师做饭</span><br><span class="line">pool-1-thread-2 -&gt; 厨师煲汤</span><br><span class="line">pool-1-thread-1 -&gt; 顾客吃饭：蛋炒饭 顾客喝汤：鱼汤</span><br><span class="line">main -&gt; 餐厅收款：60元</span><br></pre></td></tr></table></figure><p>如果我们把<code>thenCombine</code>换成<code>thenCombineAsync</code>，且使用自定义线程池EXECUTOR，可以看到函数任务在第三个线程执行了：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pool-1-thread-1 -&gt; 厨师做饭</span><br><span class="line">pool-1-thread-2 -&gt; 厨师煲汤</span><br><span class="line">pool-1-thread-3 -&gt; 顾客吃饭：蛋炒饭 顾客喝汤：鱼汤</span><br><span class="line">main -&gt; 餐厅收款：60元</span><br></pre></td></tr></table></figure><p>通过这两个简单的例子我们很容易猜到非Async方法的任务线程会保持与唤醒这个它的任务线程处于同一个CompletionStage任务阶段，那么他底层是如何实现的呢？</p><h2 id="Completion"><a href="#Completion" class="headerlink" title="Completion"></a>Completion</h2><p>实际上，CompletableFuture维护一个<code>CompletionNode</code>链栈，每个栈结点中有一个<code>Completion</code>类型的抽象父类，用于注册不同的阶段操作，可以理解为“观察者”。</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">volatile</span> CompletionNode completions; <span class="comment">// list (Treiber stack) of completions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">CompletionNode</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> Completion completion;</span><br><span class="line">    <span class="keyword">volatile</span> CompletionNode next;</span><br><span class="line">    CompletionNode(Completion completion) &#123; <span class="built_in">this</span>.completion = completion; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@SuppressWarnings(&quot;serial&quot;)</span></span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Completion</span> <span class="keyword">extends</span> <span class="title class_">AtomicInteger</span> <span class="keyword">implements</span> <span class="title class_">Runnable</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CompletableFuture内部有众多Completion类型的内部类实现，例如：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThenApply</span>&lt;T,U&gt; <span class="keyword">extends</span> <span class="title class_">Completion</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; src;</span><br><span class="line">    <span class="keyword">final</span> Function&lt;? <span class="built_in">super</span> T,? <span class="keyword">extends</span> <span class="title class_">U</span>&gt; fn;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;U&gt; dst;</span><br><span class="line">    <span class="keyword">final</span> Executor executor;</span><br><span class="line"><span class="comment">// 省略内部方法......</span></span><br><span class="line">    </span><br><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">ThenCombine</span>&lt;T,U,V&gt; <span class="keyword">extends</span> <span class="title class_">Completion</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;? <span class="keyword">extends</span> <span class="title class_">T</span>&gt; src;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;? <span class="keyword">extends</span> <span class="title class_">U</span>&gt; snd;</span><br><span class="line">    <span class="keyword">final</span> BiFunction&lt;? <span class="built_in">super</span> T,? <span class="built_in">super</span> U,? <span class="keyword">extends</span> <span class="title class_">V</span>&gt; fn;</span><br><span class="line">    <span class="keyword">final</span> CompletableFuture&lt;V&gt; dst;</span><br><span class="line">    <span class="keyword">final</span> Executor executor;</span><br><span class="line"><span class="comment">// 省略内部方法......</span></span><br></pre></td></tr></table></figure><p>这里以依旧以<code>thenCombine</code>厨师为例，我们跟进源码看看：<img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_11-34-29.png" alt="PixPin_2024-02-06_11-34-29"></p><p>继续进入<code>doThenCombine</code>方法：</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_11-36-14.png" alt="PixPin_2024-02-06_11-36-14"></p><ul><li>1631：程序判断了两个任务的result是否都有值，不满足条件进入if语句内（提前设置任务随眠）。</li><li>1632：这里创建了一个<code>ThenCombine</code>类并把自身任务、另一个任务、二元函数fn等信息存入，这个ThenCombine就是上面提到的<code>Completion</code>的一个具体类型。</li><li>1633：创建了一个<code>CompletionNode</code>结点保存<code>ThenCombine</code>，即入栈。</li></ul><p>继续往后走，程序依赖于<code>Unsafe</code>类，对两个任务的返回值、异常进行了一系列的<code>CAS</code>判断，<strong>如果在这期间两个任务都执行完毕，且均未抛出异常</strong>，程序则会执行二元函数BiFunction的apply方法，也就是lambda表达式内的方法，并把两个任务的结果传递进去：</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_11-56-02.png" alt="PixPin_2024-02-06_11-56-02"></p><p>如果把随眠时间调整长一些重新，程序注册完<code>Completion</code>后很快就退出了方法<code>thenCombine</code>。</p><p>然后在supplyAsync任务中打上断点，可以看见执行execAsync方法前创建了一个任务<code>AsyncSupply</code>对象，它是实际上需要执行的任务：<img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_12-03-20.png" alt="PixPin_2024-02-06_12-03-20"></p><p>继承实现关系为：<code>AsyncSupply</code> –继承–&gt; <code>Async</code> –实现–&gt; <code>Runnable</code></p><p>execAsync方内即执行了AsyncSupply任务：</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_12-18-41.png" alt="PixPin_2024-02-06_12-18-41"></p><p>那么AsyncSupply做了什么？它执行了函数式接口<code>Supplier</code>的具体实现方法<code>fn</code>，获取了返回值<code>u</code>后传递给了<code>internalComplete</code>方法：</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_12-21-59.png" alt="PixPin_2024-02-06_12-21-59"></p><p>这里同样用到了Unsafe类，继续进入<code>postComplete</code>方法：</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_12-28-29.png" alt="PixPin_2024-02-06_12-28-29"></p><p><strong>注意为了保证执行到此处的任务是最后一个任务，取消任务二的随眠时间，或者跳过第一个任务的断点</strong></p><p>这里程序进行了循环弹栈操作，两个任务结果都能够通过<code>Completion</code>获取。</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_12-46-47.png" alt="PixPin_2024-02-06_12-46-47"></p><p>上面运行的run方法即<code>ThenCombine</code>的run方法，我们进入run方法看看：</p><p><img src="/2024/02/05/1-CompletableFuture/PixPin_2024-02-06_13-02-14.png" alt="PixPin_2024-02-06_13-02-14"></p><p>还记得刚刚注册Completion的代码吗，由于我们选用了非Async方法，传入的Executor为null，<strong>于是直接在当前线程调用了二元函数fn的apply方法</strong>（随眠时间较长的任务一），这就解释了为什么非Async方法执行的函数式接口方法与上一阶段的任务处于同一个线程了，实际上CompletableFuture把它们当作任务的同一阶段了。</p><p>请注意下面三种情况，加深理解：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 情况一=================================================</span></span><br><span class="line">CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 任务一</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;).thenCombine(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 任务二</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;), (f1, f2) -&gt; &#123;</span><br><span class="line">    <span class="comment">// 代码块与后结束的任务处于同一线程</span></span><br><span class="line">    <span class="keyword">return</span> f1 * f2;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 情况二=================================================</span></span><br><span class="line">CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 任务一</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;).thenCombine(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 任务二</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;), (f1, f2) -&gt; CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 开启了第三个supplyAsync异步任务，处于新线程</span></span><br><span class="line">    <span class="keyword">return</span> f1 * f2;</span><br><span class="line">&#125;));</span><br><span class="line"><span class="comment">// 情况三=================================================</span></span><br><span class="line">CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 任务一</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;).thenCombine(CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">    <span class="comment">// 任务二</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">2</span>;</span><br><span class="line">&#125;), (f1, f2) -&gt; &#123;</span><br><span class="line">    <span class="comment">// 外层代码块与后结束的任务处于同一线程</span></span><br><span class="line">    <span class="keyword">return</span> CompletableFuture.supplyAsync(() -&gt; &#123;</span><br><span class="line">        <span class="comment">// 开启了第三个supplyAsync异步任务，处于新线程</span></span><br><span class="line">        <span class="keyword">return</span> f1 * f2;</span><br><span class="line">    &#125;).join();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>CompletableFuture的任务在不同阶段的操作依赖于CompletionStage阶段。</p><p>而任务编排方法中，相互关联的任务被互相注册为对应类型的Completion并压入CompletionNode栈，在完成任务后根据Completion判断任务是否需要进入下一阶段，弹栈通知注册任务执行相应的方法，也可能是执行后续阶段的方法。</p><p>这个过程中CompletableFuture依赖于Unsafe类的CAS操作，大部分操作实现类无锁并发。</p><p>当然上述流程省略了大量细节，CompletableFuture的运行机制远比这些复杂的多，欢迎纠错和补充。</p>]]></content>
      
      
      <categories>
          
          <category> 博客 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> CompletableFuture </tag>
            
            <tag> JUC </tag>
            
            <tag> 函数式接口 </tag>
            
            <tag> 源码解析 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>markdown样式测试</title>
      <link href="/2024/02/03/markdown%E6%A0%B7%E5%BC%8F%E6%B5%8B%E8%AF%95/"/>
      <url>/2024/02/03/markdown%E6%A0%B7%E5%BC%8F%E6%B5%8B%E8%AF%95/</url>
      
        <content type="html"><![CDATA[<p>This post is originated from here and is used for testing markdown style. This post contains nearly every markdown usage. Make sure all the markdown elements below show up correctly.</p><p>作者: Jerry<br>連結: <a href="https://butterfly.js.org/posts/89757140/">https://butterfly.js.org/posts/89757140/</a><br>來源: Butterfly</p><h1 id="Java代码块"><a href="#Java代码块" class="headerlink" title="Java代码块"></a>Java代码块</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Block comment */</span></span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> AnInterface.CONSTANT;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> java.util.Date.parse;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">static</span> SomeClass.staticField;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Doc comment here for &lt;code&gt;SomeClass&lt;/code&gt;</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> T type parameter</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@see</span> Math#sin(double)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Annotation</span> (name=value)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SomeClass</span>&lt;T <span class="keyword">extends</span> <span class="title class_">Runnable</span>&gt; &#123; <span class="comment">// some comment</span></span><br><span class="line">  <span class="keyword">private</span> <span class="type">T</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">double</span> <span class="variable">unusedField</span> <span class="operator">=</span> <span class="number">12345.67890</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="type">UnknownType</span> <span class="variable">anotherString</span> <span class="operator">=</span> <span class="string">&quot;Another\nStrin\g&quot;</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="variable">staticField</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">instanceFinalField</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">final</span> <span class="type">int</span> <span class="variable">protectedField</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="type">int</span> <span class="variable">packagePrivateField</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 语义高亮显示:</span></span><br><span class="line"><span class="comment">   * 生成的光谱为局部变量和形参选择颜色:</span></span><br><span class="line"><span class="comment">   *  Color#1 SC1.1 SC1.2 SC1.3 SC1.4 Color#2 SC2.1 SC2.2 SC2.3 SC2.4 Color#3</span></span><br><span class="line"><span class="comment">   *  Color#3 SC3.1 SC3.2 SC3.3 SC3.4 Color#4 SC4.1 SC4.2 SC4.3 SC4.4 Color#5</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> param1</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> param2</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> param3</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">public</span> <span class="title function_">SomeClass</span><span class="params">(AnInterface param1,</span></span><br><span class="line"><span class="params">                  <span class="type">int</span> param2,</span></span><br><span class="line"><span class="params">                  <span class="type">int</span> param3)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">reassignedValue</span> <span class="operator">=</span> <span class="built_in">this</span>.staticField + param2 + param3;</span><br><span class="line">    <span class="type">long</span> localVar1, localVar2, localVar3, localVar4;</span><br><span class="line">    <span class="type">int</span> <span class="variable">localVar</span> <span class="operator">=</span> <span class="string">&quot;IntelliJ&quot;</span>; <span class="comment">// Error, incompatible types</span></span><br><span class="line">    System.out.println(anotherString + toString() + localVar);</span><br><span class="line">    <span class="type">int</span> <span class="variable">sum</span> <span class="operator">=</span> protectedField + packagePrivateField + staticField;</span><br><span class="line">    <span class="type">long</span> <span class="variable">time</span> <span class="operator">=</span> parse(<span class="string">&quot;1.2.3&quot;</span>); <span class="comment">// Method is deprecated</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>().countStackFrames(); <span class="comment">// Method is deprecated and marked for removal</span></span><br><span class="line">    reassignedValue ++; </span><br><span class="line">    field.run(); </span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">SomeClass</span>() &#123;</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">a</span> <span class="operator">=</span> localVar;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="type">int</span>[] l = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;String&gt;().toArray(<span class="keyword">new</span> <span class="title class_">int</span>[CONSTANT]);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">AnEnum</span> &#123; CONST1, CONST2 &#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">AnInterface</span> &#123;</span><br><span class="line">  <span class="type">int</span> <span class="variable">CONSTANT</span> <span class="operator">=</span> <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">SomeAbstractClass</span> &#123;</span><br><span class="line">  <span class="keyword">protected</span> <span class="type">int</span> <span class="variable">instanceField</span> <span class="operator">=</span> staticField;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Headers"><a href="#Headers" class="headerlink" title="Headers"></a>Headers</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># H1</span></span><br><span class="line"><span class="section">## H2</span></span><br><span class="line"><span class="section">### H3</span></span><br><span class="line"><span class="section">#### H4</span></span><br><span class="line"><span class="section">##### H5</span></span><br><span class="line"><span class="section">###### H6</span></span><br><span class="line"></span><br><span class="line">Alternatively, for H1 and H2, an underline-ish style:</span><br><span class="line"></span><br><span class="line"><span class="section">Alt-H1</span></span><br><span class="line"><span class="section">======</span></span><br><span class="line"></span><br><span class="line"><span class="section">Alt-H2</span></span><br><span class="line"><span class="section">------</span></span><br></pre></td></tr></table></figure><h1 id="H1"><a href="#H1" class="headerlink" title="H1"></a>H1</h1><h2 id="H2"><a href="#H2" class="headerlink" title="H2"></a>H2</h2><h3 id="H3"><a href="#H3" class="headerlink" title="H3"></a>H3</h3><h4 id="H4"><a href="#H4" class="headerlink" title="H4"></a>H4</h4><h5 id="H5"><a href="#H5" class="headerlink" title="H5"></a>H5</h5><h6 id="H6"><a href="#H6" class="headerlink" title="H6"></a>H6</h6><p>Alternatively, for H1 and H2, an underline-ish style:</p><h1 id="Alt-H1"><a href="#Alt-H1" class="headerlink" title="Alt-H1"></a>Alt-H1</h1><p>Alt-H2</p><h1 id="Emphasis"><a href="#Emphasis" class="headerlink" title="Emphasis"></a>Emphasis</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Emphasis, aka italics, with <span class="emphasis">*asterisks*</span> or <span class="emphasis">_underscores_</span>.</span><br><span class="line"></span><br><span class="line">Strong emphasis, aka bold, with <span class="strong">**asterisks**</span> or <span class="strong">__underscores__</span>.</span><br><span class="line"></span><br><span class="line">Combined emphasis with <span class="strong">**asterisks and <span class="emphasis">_underscores_</span>**</span>.</span><br><span class="line"></span><br><span class="line">Strikethrough uses two tildes. ~~Scratch this.~~</span><br></pre></td></tr></table></figure><p>Emphasis, aka italics, with <em>asterisks</em> or <em>underscores</em>.</p><p>Strong emphasis, aka bold, with <strong>asterisks</strong> or <strong>underscores</strong>.</p><p>Combined emphasis with <strong>asterisks and <em>underscores</em></strong>.</p><p>Strikethrough uses two tildes. <del>Scratch this.</del></p><h1 id="Lists"><a href="#Lists" class="headerlink" title="Lists"></a>Lists</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">1.</span> First ordered list item</span><br><span class="line"><span class="bullet">2.</span> Another item</span><br><span class="line"><span class="bullet">  *</span> Unordered sub-list.</span><br><span class="line"><span class="bullet">1.</span> Actual numbers don&#x27;t matter, just that it&#x27;s a number</span><br><span class="line"><span class="bullet">  1.</span> Ordered sub-list</span><br><span class="line"><span class="bullet">4.</span> And another item.</span><br><span class="line"></span><br><span class="line">   You can have properly indented paragraphs within list items. Notice the blank line above, and the leading spaces (at least one, but we&#x27;ll use three here to also align the raw Markdown).</span><br><span class="line"></span><br><span class="line">   To have a line break without a paragraph, you will need to use two trailing spaces.  </span><br><span class="line">   Note that this line is separate, but within the same paragraph.  </span><br><span class="line">   (This is contrary to the typical GFM line break behaviour, where trailing spaces are not required.)</span><br><span class="line"></span><br><span class="line"><span class="bullet">*</span> Unordered list can use asterisks</span><br><span class="line"><span class="bullet">-</span> Or minuses</span><br><span class="line"><span class="bullet">+</span> Or pluses</span><br><span class="line"><span class="bullet">-</span> Paragraph In unordered list</span><br><span class="line"></span><br><span class="line">  For example like this.</span><br><span class="line"></span><br><span class="line">Common Paragraph with some text.</span><br><span class="line">And more text.</span><br></pre></td></tr></table></figure><ol><li>First ordered list item</li><li>Another item</li></ol><ul><li>Unordered sub-list.</li></ul><ol><li><p>Actual numbers don’t matter, just that it’s a number</p></li><li><p>Ordered sub-list</p></li><li><p>And another item.</p><p>You can have properly indented paragraphs within list items. Notice the blank line above, and the leading spaces (at least one, but we’ll use three here to also align the raw Markdown).</p><p>To have a line break without a paragraph, you will need to use two trailing spaces.<br>Note that this line is separate, but within the same paragraph.<br>(This is contrary to the typical GFM line break behaviour, where trailing spaces are not required.)</p></li></ol><ul><li>Unordered list can use asterisks</li></ul><ul><li>Or minuses</li></ul><ul><li>Or pluses</li></ul><ul><li><p>Paragraph In unordered list</p><p>For example like this.</p></li></ul><p>Common Paragraph with some text.<br>And more text.</p><h1 id="Inline-HTML"><a href="#Inline-HTML" class="headerlink" title="Inline HTML"></a>Inline HTML</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span></span>To reboot your computer, press <span class="language-xml"><span class="tag">&lt;<span class="name">kbd</span>&gt;</span></span>ctrl<span class="language-xml"><span class="tag">&lt;/<span class="name">kbd</span>&gt;</span></span>+<span class="language-xml"><span class="tag">&lt;<span class="name">kbd</span>&gt;</span></span>alt<span class="language-xml"><span class="tag">&lt;/<span class="name">kbd</span>&gt;</span></span>+<span class="language-xml"><span class="tag">&lt;<span class="name">kbd</span>&gt;</span></span>del<span class="language-xml"><span class="tag">&lt;/<span class="name">kbd</span>&gt;</span></span>.<span class="language-xml"><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span></span><br></pre></td></tr></table></figure><p>To reboot your computer, press <kbd>ctrl</kbd>+<kbd>alt</kbd>+<kbd>del</kbd>.</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">dl</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;dt&gt;Definition list&lt;/dt&gt;</span></span><br><span class="line"><span class="code">    &lt;dd&gt;Is something people use sometimes.&lt;/dd&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line"><span class="code">    &lt;dt&gt;Markdown in HTML&lt;/dt&gt;</span></span><br><span class="line"><span class="code">    &lt;dd&gt;Does *not* work **very** well. Use HTML &lt;em&gt;tags&lt;/em&gt;.&lt;/dd&gt;</span></span><br><span class="line"><span class="code">&lt;/dl&gt;</span></span><br></pre></td></tr></table></figure><dl>    <dt>Definition list</dt>    <dd>Is something people use sometimes.</dd><pre><code>&lt;dt&gt;Markdown in HTML&lt;/dt&gt;&lt;dd&gt;Does *not* work **very** well. Use HTML &lt;em&gt;tags&lt;/em&gt;.&lt;/dd&gt;</code></pre></dl><h1 id="Links"><a href="#Links" class="headerlink" title="Links"></a>Links</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">I&#x27;m an inline-style link</span>](<span class="link">https://www.google.com</span>)</span><br><span class="line"></span><br><span class="line">[<span class="string">I&#x27;m an inline-style link with title</span>](<span class="link">https://www.google.com &quot;Google&#x27;s Homepage&quot;</span>)</span><br><span class="line"></span><br><span class="line">[<span class="string">I&#x27;m a reference-style link</span>][<span class="symbol">Arbitrary case-insensitive reference text</span>]</span><br><span class="line"></span><br><span class="line">[<span class="string">I&#x27;m a relative reference to a repository file</span>](<span class="link">../blob/master/LICENSE</span>)</span><br><span class="line"></span><br><span class="line">[<span class="string">You can use numbers for reference-style link definitions</span>][<span class="symbol">1</span>]</span><br><span class="line"></span><br><span class="line">Or leave it empty and use the [link text itself]</span><br><span class="line"></span><br><span class="line">Some text to show that the reference links can follow later.</span><br><span class="line"></span><br><span class="line">[<span class="symbol">arbitrary case-insensitive reference text</span>]: <span class="link">https://hexo.io</span></span><br><span class="line">[<span class="symbol">1</span>]: <span class="link">https://hexo.io/docs/</span></span><br><span class="line">[<span class="symbol">link text itself</span>]: <span class="link">https://hexo.io/api/</span></span><br></pre></td></tr></table></figure><p><a href="https://www.google.com/">I’m an inline-style link</a></p><p><a href="https://www.google.com/" title="Google&#39;s Homepage">I’m an inline-style link with title</a></p><p><a href="https://hexo.io/">I’m a reference-style link</a></p><p><a href="../blob/master/LICENSE">I’m a relative reference to a repository file</a></p><p><a href="https://hexo.io/docs/">You can use numbers for reference-style link definitions</a></p><p>Or leave it empty and use the <a href="https://hexo.io/api/">link text itself</a></p><p>Some text to show that the reference links can follow later.</p><h1 id="Images"><a href="#Images" class="headerlink" title="Images"></a>Images</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">hover to see the title text:</span><br><span class="line"></span><br><span class="line">Inline-style:</span><br><span class="line"></span><br><span class="line">![<span class="string">alt text</span>](<span class="link">https://hexo.io/icon/favicon-196x196.png &quot;Logo Title Text 1&quot;</span>)</span><br><span class="line"></span><br><span class="line">Reference-style:</span><br><span class="line">![<span class="string">alt text</span>][<span class="symbol">logo</span>]</span><br><span class="line"></span><br><span class="line">[<span class="symbol">logo</span>]: <span class="link">https://hexo.io/icon/favicon-196x196.png &quot;Logo Title Text 2&quot;</span></span><br></pre></td></tr></table></figure><p>hover to see the title text:</p><p>Inline-style:</p><p><img src="https://hexo.io/icon/favicon-196x196.png" alt="alt text" title="Logo Title Text 1"></p><p>Reference-style:<br><img src="https://hexo.io/icon/favicon-196x196.png" alt="alt text" title="Logo Title Text 2"></p><h1 id="Code-and-Syntax-Highlighting"><a href="#Code-and-Syntax-Highlighting" class="headerlink" title="Code and Syntax Highlighting"></a>Code and Syntax Highlighting</h1><p>Inline code has back-ticks around it.</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> s = <span class="string">&quot;JavaScript syntax highlighting&quot;</span>;</span><br><span class="line"><span class="title function_">alert</span>(s);</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">s = <span class="string">&quot;Python syntax highlighting&quot;</span></span><br><span class="line"><span class="built_in">print</span> s</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">No language indicated, so no syntax highlighting.</span><br><span class="line">But let&#x27;s throw in a &lt;b&gt;tag&lt;/b&gt;.</span><br></pre></td></tr></table></figure><h1 id="Tables"><a href="#Tables" class="headerlink" title="Tables"></a>Tables</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">|                |ASCII                          |HTML                         |</span><br><span class="line">|----------------|-------------------------------|-----------------------------|</span><br><span class="line">|Single backticks|<span class="code">`&#x27;Isn&#x27;t this fun?&#x27;`</span>            |&#x27;Isn&#x27;t this fun?&#x27;            |</span><br><span class="line">|Quotes          |<span class="code">`&quot;Isn&#x27;t this fun?&quot;`</span>            |&quot;Isn&#x27;t this fun?&quot;            |</span><br><span class="line">|Dashes          |<span class="code">`-- is en-dash, --- is em-dash`</span>|-- is en-dash, --- is em-dash|</span><br></pre></td></tr></table></figure><table><thead><tr><th></th><th>ASCII</th><th>HTML</th></tr></thead><tbody><tr><td>Single backticks</td><td><code>&#39;Isn&#39;t this fun?&#39;</code></td><td>‘Isn’t this fun?’</td></tr><tr><td>Quotes</td><td><code>&quot;Isn&#39;t this fun?&quot;</code></td><td>“Isn’t this fun?”</td></tr><tr><td>Dashes</td><td><code>-- is en-dash, --- is em-dash</code></td><td>– is en-dash, — is em-dash</td></tr></tbody></table><p>Colons can be used to align columns.</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">| Tables        | Are           | Cool  |</span><br><span class="line">| ------------- |:-------------:| -----:|</span><br><span class="line">| col 3 is      | right-aligned |  |</span><br><span class="line">| col 2 is      | centered      |    |</span><br><span class="line">| zebra stripes | are neat      |   </span><br></pre></td></tr></table></figure><table><thead><tr><th>Tables</th><th align="center">Are</th><th align="right">Cool</th></tr></thead><tbody><tr><td>col 3 is</td><td align="center">right-aligned</td><td align="right"></td></tr><tr><td>col 2 is</td><td align="center">centered</td><td align="right"></td></tr><tr><td>zebra stripes</td><td align="center">are neat</td><td align="right"></td></tr></tbody></table><p>The outer pipes (|) are optional, and you don’t need to make the raw Markdown line up prettily. You can also use inline Markdown.</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Markdown | Less | Pretty</span><br><span class="line">--- | --- | ---</span><br><span class="line"><span class="emphasis">*Still*</span> | <span class="code">`renders`</span> | <span class="strong">**nicely**</span></span><br><span class="line">1 | 2 | 3</span><br></pre></td></tr></table></figure><table><thead><tr><th>Markdown</th><th>Less</th><th>Pretty</th></tr></thead><tbody><tr><td><em>Still</em></td><td><code>renders</code></td><td><strong>nicely</strong></td></tr><tr><td>1</td><td>2</td><td>3</td></tr></tbody></table><blockquote><p>You can find more information about LaTeX mathematical expressions here.</p></blockquote><h1 id="Blockquotes"><a href="#Blockquotes" class="headerlink" title="Blockquotes"></a>Blockquotes</h1><blockquote><p>Blockquotes are very handy in email to emulate reply text.<br>This line is part of the same quote.</p></blockquote><p>Quote break.</p><blockquote><p>This is a very long line that will still be quoted properly when it wraps. Oh boy let’s keep writing to make sure this is long enough to actually wrap for everyone. Oh, you can put Markdown into a blockquote.</p></blockquote><h1 id="Horizontal-Rule"><a href="#Horizontal-Rule" class="headerlink" title="Horizontal Rule"></a>Horizontal Rule</h1><p>Three or more…</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line"></span><br><span class="line">Hyphens</span><br><span class="line"></span><br><span class="line"><span class="strong">***</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">Asterisks</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">___</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">Underscores</span></span><br></pre></td></tr></table></figure><hr><p>Hyphens</p><hr><p>Asterisks</p><hr><p>Underscores</p><h1 id="Line-Breaks"><a href="#Line-Breaks" class="headerlink" title="Line Breaks"></a>Line Breaks</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Here&#x27;s a line for us to start with.</span><br><span class="line"></span><br><span class="line">This line is separated from the one above by two newlines, so it will be a <span class="emphasis">*separate paragraph*</span>.</span><br><span class="line"></span><br><span class="line">This line is also a separate paragraph, but...</span><br><span class="line">This line is only separated by a single newline, so it&#x27;s a separate line in the <span class="emphasis">*same paragraph*</span>.</span><br></pre></td></tr></table></figure><p>Here’s a line for us to start with.</p><p>This line is separated from the one above by two newlines, so it will be a <em>separate paragraph</em>.</p><p>This line is also a separate paragraph, but…<br>This line is only separated by a single newline, so it’s a separate line in the <em>same paragraph</em>.</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">This is a regular paragraph.</span><br><span class="line"></span><br><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">table</span>&gt;</span></span></span><br><span class="line"><span class="code">    &lt;tr&gt;</span></span><br><span class="line"><span class="code">        &lt;td&gt;Foo&lt;/td&gt;</span></span><br><span class="line"><span class="code">    &lt;/tr&gt;</span></span><br><span class="line"><span class="code">&lt;/table&gt;</span></span><br><span class="line"><span class="code"></span></span><br><span class="line">This is another regular paragraph.</span><br></pre></td></tr></table></figure><p>This is a regular paragraph.</p><table>    <tr>        <td>Foo</td>    </tr></table><p>This is another regular paragraph.</p><h1 id="Youtube-videos"><a href="#Youtube-videos" class="headerlink" title="Youtube videos"></a>Youtube videos</h1><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="language-xml"><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;https://www.youtube.com/watch?feature=player_embedded&amp;v=ARted4RniaU</span></span></span></span><br><span class="line"><span class="string"><span class="tag"><span class="language-xml">&quot;</span> <span class="attr">target</span>=<span class="string">&quot;_blank&quot;</span>&gt;</span></span><span class="language-xml"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;https://img.youtube.com/vi/ARted4RniaU/0.jpg&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="attr">alt</span>=<span class="string">&quot;IMAGE ALT TEXT HERE&quot;</span> <span class="attr">width</span>=<span class="string">&quot;240&quot;</span> <span class="attr">height</span>=<span class="string">&quot;180&quot;</span> <span class="attr">border</span>=<span class="string">&quot;10&quot;</span> /&gt;</span></span><span class="language-xml"><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">Pure markdown version:</span><br><span class="line"></span><br><span class="line">[<span class="string">![IMAGE ALT TEXT HERE</span>](<span class="link">https://img.youtube.com/vi/ARted4RniaU/0.jpg</span>)](<span class="link">https://www.youtube.com/watch?v=ARted4RniaU</span>)</span><br></pre></td></tr></table></figure><p><a href="https://www.youtube.com/watch?feature=player_embedded&v=ARted4RniaU" target="_blank"><img src="https://img.youtube.com/vi/ARted4RniaU/0.jpg"alt="IMAGE ALT TEXT HERE" width="240" height="180" border="10" /></a></p><p>Pure markdown version:</p><p><a href="https://www.youtube.com/watch?v=ARted4RniaU"><img src="https://img.youtube.com/vi/ARted4RniaU/0.jpg" alt="IMAGE ALT TEXT HERE"></a></p>]]></content>
      
      
      <categories>
          
          <category> 文档 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> markdown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>测试博客</title>
      <link href="/2024/02/02/%E6%B5%8B%E8%AF%95%E5%8D%9A%E5%AE%A2/"/>
      <url>/2024/02/02/%E6%B5%8B%E8%AF%95%E5%8D%9A%E5%AE%A2/</url>
      
        <content type="html"><![CDATA[<h1 id="ql-boot-template"><a href="#ql-boot-template" class="headerlink" title="ql-boot-template"></a>ql-boot-template</h1><blockquote><p>失手扑空蓝色的蜻蛉</p><p>Author: <a href="https://github.com/chocohQL">chocohQL</a></p><p>GitHub: <a href="https://github.com/chocohQL/ql-boot-template">https://github.com/chocohQL/ql-boot-template</a></p></blockquote><h2 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h2><p>ql-boot-template 是一个多模块SpringBoot模板项目，已配置好基本框架和通用代码，用于快速搭建一个中小型的后端项目。</p><ul><li>后端项目基于 SpirngBoot + SpringSecuity 搭建</li><li>内置自定义 spring-boot-starter 模板</li></ul><h2 id="相关项目"><a href="#相关项目" class="headerlink" title="相关项目"></a>相关项目</h2><ul><li>前端配套测试项目：<a href="https://github.com/chocohQL/ql-vue-template">ql-vue-template</a></li><li>SpringBoot极简模板项目（ql-boot-template青春版）：<a href="https://github.com/chocohQL/ql-boot-simple">ql-boot-simple</a></li></ul><h2 id="技术选型"><a href="#技术选型" class="headerlink" title="技术选型"></a>技术选型</h2><ul><li>JDK 8</li><li>SpringBoot</li><li>SpringSecurity</li><li>MyBatisPlus</li><li>MySQL</li><li>Redis</li></ul><h2 id="项目架构"><a href="#项目架构" class="headerlink" title="项目架构"></a>项目架构</h2><p><img src="https://fastly.jsdelivr.net/gh/chocohQL/ql-file@main/assets/github/ql-boot-template-%E6%9E%B6%E6%9E%84.svg"></p><p>项目主要分为4个模块:</p><ul><li>核心框架(ql-framework)：主要用于编写核心业务、全局配置、异常处理等。</li><li>数据访模块(ql-dal)：用于定义实体类和数据库映射。</li><li>安全模块(ql-security)：用于编写安全相关的代码，如安全配置、认证授权逻辑等。</li><li>通用模块(ql-common)：用于编写通用工具类、常量类、异常类等。</li><li>starter模板(ql-spring-boot)：简易的spring-boot-starter模板。</li></ul><h2 id="项目结构"><a href="#项目结构" class="headerlink" title="项目结构"></a>项目结构</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">ql-boot-template  </span><br><span class="line">├── ql-common                           // 通用模块</span><br><span class="line">│       └── annotation                      // 注解</span><br><span class="line">│       └── constant                        // 常量</span><br><span class="line">│       └── exception                       // 异常类</span><br><span class="line">│       └── model                           // 数据模型</span><br><span class="line">│       └── utils                           // 工具类</span><br><span class="line">├── ql-framework                        // 核心模块</span><br><span class="line">│       └── ascept                          // 切面</span><br><span class="line">│       └── config                          // 全局配置</span><br><span class="line">│       └── controller                      // 控制层</span><br><span class="line">│       └── exception                       // 异常处理</span><br><span class="line">│       └── service                         // 业务层</span><br><span class="line">├── ql-security                         // 安全模块</span><br><span class="line">│       └── filter                          // 过滤器</span><br><span class="line">│       └── handler                         // 处理器</span><br><span class="line">│       └── service                         // 认证业务</span><br><span class="line">├── ql-security                         // 安全模块</span><br><span class="line">│       └── config                          // 配置</span><br><span class="line">│       └── filter                          // 过滤器</span><br><span class="line">│       └── handler                         // 处理器</span><br><span class="line">│       └── service                         // 认证业务</span><br><span class="line">├── ql-dal                              // 数据持久层</span><br><span class="line">│       └── domain                          // 数据层</span><br><span class="line">│       └── mapper                          // 持久层</span><br><span class="line">├── ql-spring-boot                      // spring-boot-starter模板</span><br><span class="line">│       └── ql-spring-boot-autoconfigure    // starter自动配置</span><br><span class="line">│       └── ql-spring-boot-starter          // starter入口</span><br></pre></td></tr></table></figure><h2 id="快速开始"><a href="#快速开始" class="headerlink" title="快速开始"></a>快速开始</h2><ol><li>创建数据库表</li></ol><p><code>sql/ql_boot_template.sql</code></p><p>创建数据库执行sql文件，仅生成一个 user 表，对应 User 类，可按需扩充字段。</p><ol start="2"><li>修改application.yml文件</li></ol><p><code>ql-framework/src/main/resources/application.yml</code></p><p>修改 MySQL 和 Redis 连接配置</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/ql_boot_template?serverTimezone=UTC&amp;useUnicode=true&amp;characterEncoding=utf8&amp;useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">yourPassword</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.zaxxer.hikari.HikariDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">redis:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="string">localhost</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">yourPassword</span></span><br></pre></td></tr></table></figure><ol start="3"><li>测试启动</li></ol><p>启动前后端项目，默认实现了登录和退出登录接口。（sql中生成的测试用户 -&gt; 用户名:chocoh，密码:123123）</p><p>前端测试项目：<a href="https://github.com/chocohQL/ql-vue-template">ql-vue-template</a></p><h2 id="了解更多"><a href="#了解更多" class="headerlink" title="了解更多"></a>了解更多</h2><h3 id="授权认证"><a href="#授权认证" class="headerlink" title="授权认证"></a>授权认证</h3><p>使用SpringSecurity授权认证流程</p><p><img src="https://fastly.jsdelivr.net/gh/chocohQL/ql-file@main/assets/github/ql-security.svg"></p><p>ql-security 模块对 SpringSecurity 进行了封装，在 SecurityConfig 中同一配置：</p><ul><li>TokenService 中封装了对jwt的操作和在Redis保存用户信息的逻辑，可在此集中修改封装基于token的一系列逻辑。</li><li>UserDetailsServiceImpl 中实现了登录查询用户信息的逻辑。AuthenticationService 中定义了用户密码的校验逻辑，可在次基础上进一步修改角色管理逻辑。</li><li>handler 包主要定义了一些处理逻辑，如退出登录、认证失败等。</li></ul><h3 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h3><h3 id="修改客户端配置"><a href="#修改客户端配置" class="headerlink" title="修改客户端配置"></a>修改客户端配置</h3><p>项目提供了多种现成客户端、工具：</p><ul><li>EmailClient：用于邮箱发送</li><li>OssClient：用于阿里云OSS对象存储</li><li>RedisService：对RedisTemplate常用操作的封装</li></ul><p>配置使用客户端：</p><ol><li>修改配置文件</li></ol><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">email:</span></span><br><span class="line">  <span class="attr">host:</span> <span class="string">smtp.qq.com</span></span><br><span class="line">  <span class="attr">from:</span> <span class="string">change@qq.com</span></span><br><span class="line">  <span class="attr">password:</span> <span class="string">change</span></span><br><span class="line">  <span class="attr">username:</span> <span class="string">change@qq.com</span></span><br><span class="line"></span><br><span class="line"><span class="attr">oss:</span></span><br><span class="line">  <span class="attr">endpoint:</span> <span class="string">change</span></span><br><span class="line">  <span class="attr">url:</span> <span class="string">change</span></span><br><span class="line">  <span class="attr">bucket-name:</span> <span class="string">chocoh</span></span><br><span class="line">  <span class="attr">access-key-id:</span> <span class="string">change</span></span><br><span class="line">  <span class="attr">access-key-secret:</span> <span class="string">change</span></span><br><span class="line">  <span class="attr">file-dir:</span> <span class="string">ql/avatar/</span></span><br></pre></td></tr></table></figure><ol start="2"><li>注册客户端为bean</li></ol><p><code>ql-framework/src/main/java/com/chocoh/ql/framework/config/ClientConfig.java</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClientConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> EmailClient <span class="title function_">emailClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">EmailClient</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> OssClient <span class="title function_">ossClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">OssClient</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="超级响应类"><a href="#超级响应类" class="headerlink" title="超级响应类"></a>超级响应类</h3><p><code>com.chocoh.ql.common.model.Response</code></p><ul><li>类名调用直接响应基本的 {msg, code, data} 结构。</li><li>继承 HashMap ，内置了 DataMap 内部类，方便链式调用生成各种复杂的响应结构。</li></ul><h4 id="常用结构"><a href="#常用结构" class="headerlink" title="常用结构"></a>常用结构</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> Response.success(<span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;());</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;操作成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="通过链式调用实现各种复杂结构"><a href="#通过链式调用实现各种复杂结构" class="headerlink" title="通过链式调用实现各种复杂结构"></a>通过链式调用实现各种复杂结构</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Response</span> <span class="variable">response</span> <span class="operator">=</span> Response.dataMap()</span><br><span class="line">        .put(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;参数一&quot;</span>)</span><br><span class="line">        .put(<span class="string">&quot;2&quot;</span>, <span class="string">&quot;参数二&quot;</span>)</span><br><span class="line">        .getMap(<span class="string">&quot;3&quot;</span>)</span><br><span class="line">        .put(<span class="string">&quot;3.1&quot;</span>, System.currentTimeMillis())</span><br><span class="line">        .put(<span class="string">&quot;3.2&quot;</span>, <span class="keyword">new</span> <span class="title class_">Random</span>().nextInt(<span class="number">8</span>))</span><br><span class="line">        .getMap(<span class="string">&quot;3.3&quot;</span>)</span><br><span class="line">        .put(<span class="string">&quot;4.1&quot;</span>, Constants.HEADER_TOKEN)</span><br><span class="line">        .put(<span class="string">&quot;4.2&quot;</span>, <span class="keyword">new</span> <span class="title class_">User</span>(<span class="number">1L</span>, <span class="string">&quot;chocoh&quot;</span>, <span class="string">&quot;123123&quot;</span>, <span class="string">&quot;admin&quot;</span>))</span><br><span class="line">        .put(<span class="string">&quot;4.3&quot;</span>, <span class="keyword">new</span> <span class="title class_">Response</span>.DataMap().put(<span class="string">&quot;5.1&quot;</span>, <span class="literal">true</span>).put(<span class="string">&quot;5.2&quot;</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">        .ok()</span><br><span class="line">        .put(<span class="string">&quot;其他外层参数&quot;</span>, <span class="string">&quot;...&quot;</span>);</span><br><span class="line">QlApplicationTest.printJson(response);</span><br></pre></td></tr></table></figure><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;msg&quot;</span><span class="punctuation">:</span><span class="string">&quot;操作成功&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;其他外层参数&quot;</span><span class="punctuation">:</span><span class="string">&quot;...&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span><span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;1&quot;</span><span class="punctuation">:</span><span class="string">&quot;参数一&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;2&quot;</span><span class="punctuation">:</span><span class="string">&quot;参数二&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;3.1&quot;</span><span class="punctuation">:</span><span class="number">1703938143220</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;3.2&quot;</span><span class="punctuation">:</span><span class="number">5</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;3.3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;4.1&quot;</span><span class="punctuation">:</span><span class="string">&quot;Authorization&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;4.2&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;password&quot;</span><span class="punctuation">:</span><span class="string">&quot;123123&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;role&quot;</span><span class="punctuation">:</span><span class="string">&quot;admin&quot;</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span><span class="string">&quot;chocoh&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;4.3&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;5.1&quot;</span><span class="punctuation">:</span><span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;5.2&quot;</span><span class="punctuation">:</span><span class="string">&quot;&quot;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure><h4 id="其他结构"><a href="#其他结构" class="headerlink" title="其他结构"></a>其他结构</h4><p>如果不想使用 {msg, code, data} 结构，可以直接使用无参构造创建一个空 Response 对象，通过链式调用定制内容。</p>]]></content>
      
      
      <categories>
          
          <category> 博客 </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Java </tag>
            
            <tag> SpringBoot </tag>
            
            <tag> SpringSecurity </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
